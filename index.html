<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lista della Spesa - Famiglia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    body { overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch; }
    button, input { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
<div id="app" class="p-3 md:p-4"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, onValue, set, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBmWi-5wQ97PA4TanAC5mHFAqmsNR9aUpE",
  authDomain: "lista-spesa-famiglia-95127.firebaseapp.com",
  databaseURL: "https://lista-spesa-famiglia-95127-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "lista-spesa-famiglia-95127",
  storageBucket: "lista-spesa-famiglia-95127.firebasestorage.app",
  messagingSenderId: "131762886904",
  appId: "1:131762886904:web:068e00b3e2e08235e9c30d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let state = {
  items: [],
  frequentItems: [],
  statistics: [],
  showFrequent: true,
  showStatistics: false,
  frequentSortMode: 'usage',
  newItem: '',
  selectedPhoto: null,
  message: null,
  showMessageInput: false,
  showRecipes: false,
  recipes: []
};

const itemsRef = ref(db, 'shoppingList');
const frequentRef = ref(db, 'frequentItems');
const messageRef = ref(db, 'familyMessage');
const statisticsRef = ref(db, 'statistics');

onValue(itemsRef, snapshot => {
  const data = snapshot.val();
  state.items = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
  render();
});
onValue(frequentRef, snapshot => {
  const data = snapshot.val();
  state.frequentItems = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
  render();
});
onValue(messageRef, snapshot => {
  state.message = snapshot.val();
  render();
});
onValue(statisticsRef, snapshot => {
  const data = snapshot.val();
  state.statistics = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
  render();
});

function getProductIcon(name) {
  const n = name.toLowerCase();
  if (n.includes('mela') || n.includes('mele')) return 'üçé';
  if (n.includes('banana') || n.includes('banane')) return 'üçå';
  if (n.includes('pane')) return 'üçû';
  if (n.includes('latte')) return 'ü•õ';
  if (n.includes('pasta')) return 'üçù';
  if (n.includes('pomodor')) return 'üçÖ';
  if (n.includes('formaggio')) return 'üßÄ';
  if (n.includes('uova')) return 'ü•ö';
  if (n.includes('acqua')) return 'üíß';
  if (n.includes('caff√®')) return '‚òï';
  return 'üõí';
}

// ----------- GESTIONE LISTA ----------------
async function addItem() {
  const name = state.newItem.trim();
  if (!name) return;
  const icon = getProductIcon(name);
  const newItemRef = push(itemsRef);
  const itemData = { name, icon, checked: false, addedAt: new Date().toISOString() };
  if (state.selectedPhoto) itemData.photo = state.selectedPhoto;
  await set(newItemRef, itemData);

  const exists = state.frequentItems.find(f => f.name.toLowerCase() === name.toLowerCase());
  if (!exists) {
    const newFreqRef = push(frequentRef);
    await set(newFreqRef, { name, icon, usageCount: 1, lastUsed: new Date().toISOString() });
  }

  state.newItem = '';
  state.selectedPhoto = null;
  render();
  setTimeout(() => {
    document.getElementById('newItemInput')?.focus();
    document.getElementById('photoInput')?.value = '';
  }, 50);
}

async function toggleItem(id) {
  const item = state.items.find(i => i.id === id);
  if (item) {
    const itemRef = ref(db, `shoppingList/${id}`);
    const newCheckedState = !item.checked;
    await update(itemRef, { checked: newCheckedState });
    if (newCheckedState) await updateStatistics(item.name, item.icon);
  }
}

async function deleteItem(id) { await remove(ref(db, `shoppingList/${id}`)); }
async function clearCompleted() {
  for (const i of state.items.filter(i => i.checked)) await remove(ref(db, `shoppingList/${i.id}`));
}
async function removeFromFrequent(id) { await remove(ref(db, `frequentItems/${id}`)); }
async function addFromFrequent(freqId) {
  const freq = state.frequentItems.find(f => f.id === freqId); if(!freq) return;
  if (state.items.some(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked)) return;
  const newItemRef = push(itemsRef);
  await set(newItemRef, { name: freq.name, icon: freq.icon, checked: false, addedAt: new Date().toISOString() });
  await update(ref(db, `frequentItems/${freq.id}`), { usageCount: (freq.usageCount || 0)+1, lastUsed: new Date().toISOString() });
}

// ----------- MESSAGGI ----------------
async function saveMessage() {
  const input = document.getElementById('messageInput');
  const text = input?.value?.trim();
  if(!text) return alert('Scrivi un messaggio prima!');
  await set(messageRef, { text, author:'Famiglia', timestamp: new Date().toISOString() });
  state.showMessageInput = false; render();
}
async function deleteMessage() { await remove(messageRef); state.showMessageInput=false; render(); }

// ----------- STATISTICHE ----------------
async function updateStatistics(name, icon) {
  const normalized = name.toLowerCase();
  const existing = state.statistics.find(s => s.name.toLowerCase() === normalized);
  if(existing) {
    await update(ref(db, `statistics/${existing.id}`), { count: (existing.count||0)+1, lastPurchase: new Date().toISOString() });
  } else {
    const newStatRef = push(statisticsRef);
    await set(newStatRef, { name, icon, count:1, firstPurchase:new Date().toISOString(), lastPurchase:new Date().toISOString() });
  }
}

// ----------- FOTO ----------------
function handlePhotoSelect(e) {
  const file = e.target.files[0]; if(!file) return;
  if(file.size > 2*1024*1024) { alert('Foto troppo grande (>2MB)'); e.target.value=''; state.selectedPhoto=null; render(); return; }
  const reader = new FileReader();
  reader.onload = () => { state.selectedPhoto = reader.result; render(); };
  reader.onerror = () => { alert('Errore caricamento foto'); e.target.value=''; };
  reader.readAsDataURL(file);
}

// ----------- RICETTE GEMINI ----------------
async function fetchRecipes() {
  state.showRecipes = true;
  state.recipes = [];
  render();
  try {
    const res = await fetch('https://api.gemini.com/v1/recipes', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer TUA_CHIAVE_API_GEMINI' },
      body: JSON.stringify({ prompt:'Dammi 5 ricette italiane facili e veloci', max_results:5 })
    });
    const data = await res.json();
    state.recipes = data.recipes.map((r,i)=>({id:`api-${i}`, title:r.title||r.name||r}));
  } catch(err){ alert('Errore recupero ricette'); console.error(err); }
  render();
}

window.toggleRecipes = () => { if(!state.showRecipes) fetchRecipes(); else { state.showRecipes=false; render(); } };

// ----------- RENDER ----------------
function render() {
  const uncheckedCount = state.items.filter(i=>!i.checked).length;
  const checkedCount = state.items.filter(i=>i.checked).length;
  const sortedFrequent = [...state.frequentItems].sort((a,b)=> state.frequentSortMode==='alphabetical' ? a.name.localeCompare(b.name,'it') : (b.usageCount||0)-(a.usageCount||0) );

  document.getElementById('app').innerHTML = `
  <div class="max-w-4xl mx-auto pb-6">
    ${state.showRecipes ? `<div class="bg-white rounded-2xl shadow-xl p-4 mt-4">
      <h2 class="text-lg font-semibold mb-3">üç≥ Ricette suggerite</h2>
      ${state.recipes.length===0 ? '<p class="text-gray-500">Caricamento...</p>' :
        state.recipes.map(r=>`<div class="p-2 border-b border-gray-200">${r.title}</div>`).join('')}
    </div>` : ''}

    <!-- RESTO DEL RENDER ORIGINALE COME NEL TUO FILE -->
    <!-- ... -->
    <!-- Qui va tutta la lista spesa, prodotti frequenti, statistiche e messaggi come nel tuo render originale -->
  </div>
  `;

  document.getElementById('newItemInput')?.addEventListener('input', e=>state.newItem=e.target.value);
  document.getElementById('newItemInput')?.addEventListener('keypress', e=>{ if(e.key==='Enter') addItem(); });
  document.getElementById('photoInput')?.addEventListener('change', handlePhotoSelect);
}

window.addItem=addItem;
window.toggleItem=toggleItem;
window.deleteItem=deleteItem;
window.clearCompleted=clearCompleted;
window.addFromFrequent=addFromFrequent;
window.removeFromFrequent=removeFromFrequent;
window.showMessageForm=()=>{ state.showMessageInput=true; render(); setTimeout(()=>document.getElementById('messageInput')?.focus(),100); };
window.cancelMessage=()=>{ state.showMessageInput=false; render(); };
window.saveMessage=saveMessage;
window.deleteMessage=deleteMessage;
window.showStatistics=()=>{ state.showStatistics=true; render(); };
window.hideStatistics=()=>{ state.showStatistics=false; render(); };
window.setSortMode=(mode)=>{ state.frequentSortMode=mode; render(); };
window.toggleFrequent=()=>{ state.showFrequent=!state.showFrequent; render(); };

render();
</script>
</body>
</html>
